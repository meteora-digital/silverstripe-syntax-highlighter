{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "name": "Silverstripe Injection",
    "scopeName": "source.silverstripe.injection",
    "injectionSelector": "L:text.html.silverstripe, L:text.html.basic, L:source.css, L:source.js",
    "patterns": [
        {
            "include": "#commentBlock"
        },
        {
            "include": "#variablePatterns"
        },
        {
            "name": "keyword.silverstripe meta.silverstripe",
            "begin": "<%(?!-)",
            "beginCaptures": {
                "0": {
                    "name": "punctuation.definition.silverstripe meta.silverstripe"
                }
            },
            "end": "(?<!-)%>",
            "endCaptures": {
                "0": {
                    "name": "punctuation.definition.silverstripe meta.silverstripe"
                }
            },
            "patterns": [
                {
                    "name": "punctuation.separator.silverstripe meta.silverstripe",
                    "match": ","
                },
                {
                    "include": "#includeControl"
                },
                {
                    "include": "#ifControl"
                },
                {
                    "include": "#string"
                }
            ]
        }
    ],
    "repository": {
        "commentBlock": {
            "name": "comment.block.silverstripe meta.silverstripe",
            "begin": "<%--",
            "beginCaptures": {
                "0": {
                    "name": "punctuation.definition.comment.begin.silverstripe meta.silverstripe"
                }
            },
            "end": "--%>",
            "endCaptures": {
                "0": {
                    "name": "punctuation.definition.comment.end.silverstripe meta.silverstripe"
                }
            },
            "contentName": "comment.block.silverstripe meta.silverstripe",
            "patterns": [
                {
                    "match": "(?:(?!--%>).)+",
                    "name": "comment.block.silverstripe meta.silverstripe"
                }
            ]
        },
        "string": {
            "patterns": [
                {
                    "name": "string.quoted.double.silverstripe string.silverstripe meta.silverstripe",
                    "begin": "\"",
                    "beginCaptures": {
                        "0": {
                            "name": "punctuation.definition.string.begin.html.silverstripe meta.silverstripe"
                        }
                    },
                    "end": "\"",
                    "endCaptures": {
                        "0": {
                            "name": "punctuation.definition.string.end.html.silverstripe meta.silverstripe"
                        }
                    }
                },
                {
                    "name": "string.quoted.single.silverstripe string.silverstripe meta.silverstripe",
                    "begin": "'",
                    "beginCaptures": {
                        "0": {
                            "name": "punctuation.definition.string.begin.html.silverstripe meta.silverstripe"
                        }
                    },
                    "end": "'",
                    "endCaptures": {
                        "0": {
                            "name": "punctuation.definition.string.end.html.silverstripe meta.silverstripe"
                        }
                    }
                }
            ]
        },
        "accessChain": {
            "patterns": [
                {
                    "name": "entity.name.function.silverstripe meta.silverstripe",
                    "match": "(\\.[a-zA-Z_][\\w]*)(?=\\()"
                },
                {
                    "name": "entity.name.function.silverstripe meta.silverstripe",
                    "match": "\\.[a-zA-Z_][\\w]*"
                },
                {
                    "name": "entity.name.function.silverstripe meta.silverstripe",
                    "begin": "\\(",
                    "end": "\\)",
                    "patterns": [
                        {
                            "include": "#variablePatterns"
                        },
                        {
                            "include": "#string"
                        },
                        {
                            "match": ",",
                            "name": "punctuation.separator.argument.silverstripe meta.silverstripe"
                        },
                        {
                            "include": "#commonExpressions"
                        }
                    ]
                }
            ]
        },
        "commonExpressions": {
            "patterns": [
                {
                    "match": "\\b\\d+\\b",
                    "name": "constant.numeric.silverstripe meta.silverstripe"
                },
                {
                    "match": "\\bnot\\b|!",
                    "name": "keyword.operator.logical.not.silverstripe meta.silverstripe"
                },
                {
                    "match": "==|=|!=|<=|>=|<|>|&&|\\|\\|",
                    "name": "keyword.operator.logical.silverstripe meta.silverstripe"
                }
            ]
        },
        "bracedVariable": {
            "name": "entity.name.silverstripe variable.silverstripe.braced",
            "begin": "(\\{)(\\$)",
            "beginCaptures": {
                "1": {
                    "name": "entity.name.silverstripe variable.silverstripe.brace"
                },
                "2": {
                    "name": "entity.name.silverstripe variable.silverstripe meta.silverstripe"
                }
            },
            "end": "(\\})",
            "endCaptures": {
                "1": {
                    "name": "entity.name.silverstripe variable.silverstripe.brace"
                }
            },
            "patterns": [
                {
                    "include": "#string"
                },
                {
                    "include": "#accessChain"
                }
            ]
        },
        "complexVariable": {
            "name": "entity.name.silverstripe variable.silverstripe.complex meta.silverstripe",
            "begin": "(\\$[a-zA-Z_][\\w]*)",
            "beginCaptures": {
                "1": {
                    "name": "entity.name.silverstripe variable.silverstripe meta.silverstripe"
                }
            },
            "end": "(?=\\s|$|[^\\w\\.$\\(\\)']|\\))",
            "patterns": [
                {
                    "include": "#accessChain"
                }
            ]
        },
        "simpleVariable": {
            "name": "entity.name.silverstripe variable.silverstripe.simple meta.silverstripe",
            "match": "\\$[a-zA-Z_][\\w]*"
        },
        "templateLiteralVariable": {
            "name": "keyword.silverstripe keyword.silverstripe.templateLiteral meta.silverstripe",
            "begin": "(\\$\\{)",
            "beginCaptures": {
                "1": {
                    "name": "punctuation.definition.silverstripe punctuation.definition.silverstripe.templateLiteral.brace meta.silverstripe"
                }
            },
            "end": "(\\})",
            "endCaptures": {
                "1": {
                    "name": "punctuation.definition.silverstripe punctuation.definition.silverstripe.templateLiteral.brace meta.silverstripe"
                }
            }
        },
        "variablePatterns": {
            "patterns": [
                {
                    "include": "#bracedVariable"
                },
                {
                    "include": "#complexVariable"
                },
                {
                    "include": "#simpleVariable"
                },
                {
                    "include": "#templateLiteralVariable"
                }
            ]
        },
        "ifControl": {
            "name": "meta.control.if.silverstripe meta.silverstripe",
            "begin": "\\bif\\b",
            "beginCaptures": {
                "0": {
                    "name": "keyword.silverstripe meta.silverstripe"
                }
            },
            "end": "(?=%>)",
            "patterns": [
                {
                    "include": "#commonExpressions"
                },
                {
                    "include": "#string"
                }
            ]
        },
        "includeControl": {
            "name": "meta.control.include.silverstripe meta.silverstripe",
            "begin": "\\binclude\\b",
            "beginCaptures": {
                "0": {
                    "name": "keyword.silverstripe meta.silverstripe"
                }
            },
            "end": "(?=%>)",
            "patterns": [
                {
                    "match": "[A-Za-z_][A-Za-z0-9_\\\\]*",
                    "name": "entity.name.type.silverstripe meta.silverstripe"
                },
                {
                    "match": "\\b([A-Za-z_][A-Za-z0-9_]*)\\b(?=\\s*=)",
                    "name": "entity.name.silverstripe meta.silverstripe"
                },
                {
                    "match": "=",
                    "name": "keyword.operator.silverstripe meta.silverstripe"
                },
                {
                    "match": ",",
                    "name": "punctuation.separator.argument.silverstripe meta.silverstripe"
                },
                {
                    "include": "#string"
                },
                {
                    "include": "#commonExpressions"
                }
            ]
        }
    }
}
