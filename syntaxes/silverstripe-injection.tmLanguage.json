{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "name": "SilverStripe Injection",
    "scopeName": "source.silverstripe.injection",
    "injectionSelector": "L:text.html.silverstripe, L:text.html.basic, L:source.css, L:source.js",
    "patterns": [
        {
            "include": "#commentBlock"
        },
        {
            "include": "#bracedVariable"
        },
        {
            "include": "#complexVariable"
        },
        {
            "include": "#simpleVariable"
        },
        {
            "name": "support.function.silverstripe",
            "begin": "<%(?!-)",
            "beginCaptures": {
                "0": { "name": "punctuation.definition.tag.begin.html.silverstripe" }
            },
            "end": "(?<!-)%>",
            "endCaptures": {
                "0": { "name": "punctuation.definition.tag.begin.html.silverstripe" }
            },
            "patterns": [
                { "include": "#ifControl" },
                { "include": "#doubleString" },
                { "include": "#singleString" }
            ],
            "contentName": "meta.silverstripe"
        }
    ],
    "repository": {
        "commentBlock": {
            "name": "comment.block.silverstripe",
            "begin": "<%--",
            "end": "--%>",
            "patterns": [
            ]
        },
        "doubleString": {
            "name": "string.quoted.double.silverstripe string.silverstripe",
            "begin": "\"",
            "beginCaptures": {
                "0": { "name": "punctuation.definition.string.begin.html.silverstripe" }
            },
            "end": "\"",
            "endCaptures": {
                "0": { "name": "punctuation.definition.string.end.html.silverstripe" }
            },
            "patterns": [
                { "name": "constant.character.escape.silverstripe", "match": "\\\\." }
            ]
        },
        "singleString": {
            "name": "string.quoted.single.silverstripe string.silverstripe",
            "begin": "'",
            "beginCaptures": {
                "0": { "name": "punctuation.definition.string.begin.html.silverstripe" }
            },
            "end": "'",
            "endCaptures": {
                "0": { "name": "punctuation.definition.string.end.html.silverstripe" }
            },
            "patterns": [
                { "name": "constant.character.escape.silverstripe", "match": "\\\\." }
            ]
        },
        "functionArguments": {
            "name": "meta.function-call.arguments.silverstripe",
            "begin": "\\(",
            "end": "\\)",
            "patterns": [
                {
                    "name": "meta.function-call.argument-list.silverstripe",
                    "patterns": [
                        { "include": "#variablePatterns" },
                        { "include": "#doubleString" },
                        { "include": "#singleString" },
                        { "match": "\\d+", "name": "constant.numeric.silverstripe" },
                        { "match": ",", "name": "punctuation.separator.argument.silverstripe" },
                        { "match": "\\s+", "name": "meta.whitespace.silverstripe" }
                    ]
                }
            ]
        },
        "attributeCall": {
            "name": "entity.other.attribute-name.html.silverstripe",
            "match": "(\\.[a-zA-Z_][\\w]*)(?=\\()",
            "captures": {
                "1": { "name": "entity.other.attribute-name.html.silverstripe" }
            }
        },
        "attribute": {
            "name": "entity.other.attribute-name.html.silverstripe",
            "match": "\\.[a-zA-Z_][\\w]*"
        },
        "bracedVariable": {
            "name": "constant.numeric.silverstripe variable.silverstripe",
            "begin": "(\\{)(\\$)",
            "beginCaptures": {
                "1": { "name": "constant.numeric.silverstripe variable.silverstripe.begin" },
                "2": { "name": "constant.numeric.silverstripe variable.silverstripe" }
            },
            "end": "(\\})",
            "endCaptures": {
                "1": { "name": "constant.numeric.silverstripe variable.silverstripe.end" }
            },
            "patterns": [
                { "include": "#doubleString" },
                { "include": "#singleString" },
                { "include": "#attributeCall" },
                { "include": "#functionArguments" },
                { "include": "#attribute" }
            ],
            "contentName": "meta.silverstripe"
        },
        "complexVariable": {
            "name": "constant.numeric.silverstripe variable.silverstripe.complex",
            "begin": "(\\$[a-zA-Z_][\\w]*)",
            "beginCaptures": {
                "1": { "name": "constant.numeric.silverstripe variable.silverstripe" }
            },
            "end": "(?=\\s|$|[^\\w\\.$\\(\\)']|\\))",
            "patterns": [
                { "include": "#attributeCall" },
                { "include": "#functionArguments" },
                { "include": "#attribute" }
            ],
            "contentName": "meta.silverstripe"
        },
        "simpleVariable": {
            "name": "constant.numeric.silverstripe variable.silverstripe.simple",
            "match": "\\$[a-zA-Z_][\\w]*",
            "captures": {
                "0": { "name": "constant.numeric.silverstripe variable.silverstripe" }
            }
        },
        "variablePatterns": {
            "patterns": [
                { "include": "#bracedVariable" },
                { "include": "#complexVariable" },
                { "include": "#simpleVariable" }
            ]
        },
        "ifControl": {
            "name": "meta.control.if.silverstripe",
            "begin": "\\bif\\b",
            "beginCaptures": {
                "0": { "name": "support.function.silverstripe" }
            },
            "end": "(?=%>)",
            "patterns": [
                { "name": "punctuation.separator.key-value.html.silverstripe", "match": "\\bnot\\b|!" },
                { "name": "punctuation.separator.key-value.html.silverstripe", "match": "==|=|!=|<=|>=|<|>|&&|\\|\\|" },
                { "name": "constant.numeric.silverstripe", "match": "\\b\\d+\\b" },
                { "include": "#singleString" },
                { "include": "#doubleString" }
            ]
        }
    }
}
